<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>ProsumatorPlanner – Live API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ProsumatorPlanner Live API – valori în timp real (cu autentificare)." />

  <style>
    :root{
      --primary:#0f766e;
      --primary-dark:#115e59;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;
      --border:#1f2937;
      --danger:#fca5a5;
      --ok:#86efac;
      --warn:#fde68a;
      --bg:#020617;
      --card:#0b1220;
      --chip:#0f172a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(15,118,110,0.18), transparent 60%),
                  radial-gradient(1000px 500px at 90% 0%, rgba(37,99,235,0.12), transparent 55%),
                  var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      display:flex;
      flex-direction: column;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 16px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
    }

    .header-left{ display:flex; align-items:center; gap: 10px; }
    .header-title{
      text-align:center;
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 1.05rem;
      white-space: nowrap;
    }
    .header-right{ display:flex; align-items:center; justify-content:flex-end; gap: 10px; color: rgba(229,231,235,0.75); font-size: 12px; }

    .btn{
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(15, 23, 42, 0.4);
      color: var(--text-main);
      text-decoration: none;
      transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease;
      user-select: none;
    }
    .btn:hover{
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(255,255,255,0.16);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(15,118,110,0.85), rgba(17,94,89,0.85));
      border-color: rgba(15,118,110,0.55);
    }
    .btn.primary:hover{
      background: linear-gradient(180deg, rgba(15,118,110,0.95), rgba(17,94,89,0.95));
    }
    .btn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }

    main{
      flex: 1;
      width: 100%;
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 26px;
    }

    .grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .header-inner{ grid-template-columns: 1fr; }
      .header-title{ text-align:left; }
      .header-right{ justify-content:flex-start; }
    }

    .card{
      background: rgba(11, 18, 32, 0.86);
      border: 1px solid rgba(31,41,55,0.9);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .card h3{
      margin: 0 0 10px 0;
      font-size: 14px;
      color: rgba(229,231,235,0.9);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .row{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .row + .row{ margin-top: 10px; }

    label{
      display:block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    input[type="text"], input[type="number"]{
      width: 100%;
      background: rgba(2,6,23,0.6);
      border: 1px solid rgba(31,41,55,0.95);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--text-main);
      outline: none;
      transition: border-color .15s ease;
      font-size: 14px;
    }
    input[type="text"]:focus, input[type="number"]:focus{
      border-color: rgba(15,118,110,0.7);
    }

    .field{
      flex: 1 1 220px;
      min-width: 220px;
    }

    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      background: rgba(15,23,42,0.55);
      border: 1px solid rgba(31,41,55,0.85);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(229,231,235,0.82);
      user-select:none;
      white-space: nowrap;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(156,163,175,0.65);
      box-shadow: 0 0 0 3px rgba(156,163,175,0.08);
    }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(134,239,172,0.10); }
    .dot.err{ background: var(--danger); box-shadow: 0 0 0 3px rgba(252,165,165,0.10); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 3px rgba(253,230,138,0.10); }

    .results{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .results{ grid-template-columns: 1fr; }
    }

    .metric{
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(31,41,55,0.85);
      border-radius: 14px;
      padding: 10px 10px 9px;
    }
    .metric .label{
      font-size: 12px;
      color: rgba(156,163,175,0.9);
      margin-bottom: 6px;
    }
    .metric .value{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.1;
    }
    .metric .hint{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(156,163,175,0.78);
    }

    pre{
      background: rgba(2,6,23,0.7);
      border: 1px solid rgba(31,41,55,0.85);
      border-radius: 14px;
      padding: 10px;
      color: rgba(229,231,235,0.88);
      overflow:auto;
      margin-top: 10px;
      font-size: 12px;
      max-height: 300px;
      display: none;
    }

    /* Footer (same as index.html) */
    .site-footer {
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      font-size: 12px;
      background: #020617;
      color: var(--text-muted);
      margin-top: 18px;
    }

    .footer-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .footer-left { display: flex; flex-direction: column; gap: 2px; }

    .footer-app-name { font-weight: 600; color: var(--text-main); }

    .footer-copy { font-size: 11px; color: var(--text-muted); }

    .footer-links {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      flex-wrap: wrap;
    }

    .footer-links a { color: var(--text-muted); text-decoration: none; }
    .footer-links a:hover { color: var(--text-main); text-decoration: underline; }
    .footer-divider { opacity: 0.6; }

    .icon{
      width: 18px; height: 18px;
      display:inline-grid;
      place-items:center;
      border-radius: 6px;
      background: rgba(15,118,110,0.18);
      border: 1px solid rgba(15,118,110,0.28);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: -0.03em;
    }

    /* Debug-only elements */
    .debug-only { display: none; }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="header-left">
        <a class="btn" href="index.html" aria-label="Înapoi la pagina principală">
          <span class="icon">P</span>
          Înapoi acasă
        </a>
      </div>
      <div class="header-title">ProsumatorPlanner – Live API</div>
      <div class="header-right"></div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">
        <div class="card">
          <h3>Setări</h3>

          <div class="row">
            <div class="field">
              <label for="siteId">Site ID</label>
              <input id="siteId" type="number" value="1" min="1" />
            </div>
            <div class="field">
              <label for="token">Token (JWT)</label>
              <input id="token" type="text" placeholder="Bearer token..." />
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="btnLatest">Preia ultimele valori</button>
            <button class="btn" id="btnSummary">Preia sumar</button>
            <button class="btn" id="btnHistory">Istoric (Premium)</button>
          </div>

          <div class="chips">
            <span class="chip">
              <span class="dot" id="statusDot"></span>
              <span id="statusText">Status: aștept token (autentificare necesară).</span>
            </span>
            <span class="chip" id="apiHint"><span class="txt">API: api.prosumatorplanner.ro</span></span>
            <span class="chip debug-only" id="lastUrlChip" style="display:none;"><span class="txt" id="lastUrlText">URL: —</span></span>
          </div>
        </div>

        <div class="card">
          <h3>Rezultate</h3>

          <div class="results" id="results">
            <div class="metric">
              <div class="label">PV</div>
              <div class="value" id="pv">—</div>
              <div class="hint">kW (instant)</div>
            </div>
            <div class="metric">
              <div class="label">Consum</div>
              <div class="value" id="house">—</div>
              <div class="hint">kW (instant)</div>
            </div>
            <div class="metric">
              <div class="label">Rețea</div>
              <div class="value" id="grid">—</div>
              <div class="hint">import / export (kW)</div>
            </div>
            <div class="metric">
              <div class="label">Baterie</div>
              <div class="value" id="soc">—</div>
              <div class="hint">SOC (%)</div>
            </div>
            <div class="metric">
              <div class="label">Conectare</div>
              <div class="value" id="connected">—</div>
              <div class="hint" id="statusHint">ultima actualizare: —</div>
            </div>
            <div class="metric">
              <div class="label">Max PV azi</div>
              <div class="value" id="maxpv">—</div>
              <div class="hint">kW (astăzi)</div>
            </div>
          </div>

          <pre id="raw" class="debug-only" style="display:none;"></pre>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-left">
        <span class="footer-app-name">ProsumatorPlanner</span>
        <span class="footer-copy">© <span id="year">2025</span> Andrei Căliman. Toate drepturile rezervate.</span>
      </div>

      <div class="footer-links">
        <a href="live.html">Live API</a>
        <span class="footer-divider">•</span>
        <a href="privacy-policy.html">Privacy Policy</a>
        <span class="footer-divider">•</span>
        <a href="terms.html">Terms &amp; Conditions</a>
      </div>
    </div>
  </footer>

  <script>
  // Footer year
  document.getElementById("year").textContent = new Date().getFullYear();

  const API_BASE = "https://api.prosumatorplanner.ro";
  const DEBUG = new URLSearchParams(location.search).get("debug") === "1";

  // Elements
  const statusTextEl = document.getElementById("statusText");
  const statusDotEl  = document.getElementById("statusDot");

  const lastUrlChip = document.getElementById("lastUrlChip");
  const lastUrlText = document.getElementById("lastUrlText");
  const rawEl       = document.getElementById("raw");

  const btnLatest  = document.getElementById("btnLatest");
  const btnSummary = document.getElementById("btnSummary");
  const btnHistory = document.getElementById("btnHistory");

  const elPv       = document.getElementById("pv");
  const elHouse    = document.getElementById("house");
  const elGrid     = document.getElementById("grid");
  const elSoc      = document.getElementById("soc");
  const elConnected= document.getElementById("connected");
  const elStatusHint = document.getElementById("statusHint");
  const elMaxPv    = document.getElementById("maxpv");

  function setDebugVisible() {
    const debugEls = document.querySelectorAll(".debug-only");
    debugEls.forEach(el => { el.style.display = DEBUG ? "" : "none"; });

    // Keep the URL chip hidden unless DEBUG and we have a URL to show
    if (!DEBUG && lastUrlChip) lastUrlChip.style.display = "none";
    if (!DEBUG && rawEl) rawEl.style.display = "none";
  }

  function setStatus(msg, kind="neutral") {
    statusTextEl.textContent = `Status: ${msg}`;
    statusDotEl.classList.remove("ok", "err", "warn");
    if (kind === "ok") statusDotEl.classList.add("ok");
    if (kind === "err") statusDotEl.classList.add("err");
    if (kind === "warn") statusDotEl.classList.add("warn");
  }

  function setLoading(isLoading) {
    btnLatest.disabled = isLoading;
    btnSummary.disabled = isLoading;
    btnHistory.disabled = isLoading;
  }

  function fmtNum(v) {
    if (v === null || v === undefined || v === "") return "—";
    const n = Number(v);
    if (!Number.isFinite(n)) return String(v);
    return n.toLocaleString("ro-RO", { minimumFractionDigits: 0, maximumFractionDigits: 3 });
  }

  function clearMetrics() {
    elPv.textContent = "—";
    elHouse.textContent = "—";
    elGrid.textContent = "—";
    elSoc.textContent = "—";
    elConnected.textContent = "—";
    elStatusHint.textContent = "ultima actualizare: —";
    elMaxPv.textContent = "—";
    if (DEBUG && rawEl) rawEl.textContent = "";
    if (lastUrlChip) lastUrlChip.style.display = "none";
  }

  function applySnapshot(data) {
    // Backend contract (v1.0):
    // { ok, site_id, connected, last_update, latest, max_pv_kw_today }
    const root = data && data.data ? data.data : data;

    const latest = root && root.latest ? root.latest : null;

    const pv = latest ? latest.pv_kw : null;
    const house = latest ? latest.house_kw : null;
    const gi = latest ? latest.grid_import_kw : null;
    const ge = latest ? latest.grid_export_kw : null;
    const soc = latest ? latest.battery_soc : null;

    elPv.textContent = fmtNum(pv);
    elHouse.textContent = fmtNum(house);

    const giTxt = fmtNum(gi);
    const geTxt = fmtNum(ge);
    elGrid.textContent = `${giTxt} / ${geTxt}`;

    elSoc.textContent = soc === null || soc === undefined ? "—" : `${soc}%`;

    const connected = !!(root && root.connected);
    elConnected.textContent = connected ? "Online" : "Offline";

    const lastUpdate = root && root.last_update ? new Date(root.last_update) : null;
    elStatusHint.textContent = lastUpdate && !isNaN(lastUpdate.getTime())
      ? `ultima actualizare: ${lastUpdate.toLocaleString("ro-RO")}`
      : "ultima actualizare: —";

    elMaxPv.textContent = fmtNum(root ? root.max_pv_kw_today : null);
  }

  function getAuthHeader() {
    const token = document.getElementById("token").value.trim();
    if (!token) return null;
    return { "Authorization": `Bearer ${token}` };
  }

  function getSiteId() {
    const v = Number(document.getElementById("siteId").value);
    return Number.isFinite(v) && v > 0 ? v : 1;
  }

  async function apiGet(path) {
    const headers = getAuthHeader();
    if (!headers) {
      setStatus("token lipsă (acces interzis fără autentificare).", "err");
      return null;
    }

    const url = `${API_BASE}${path}`;

    try {
      setLoading(true);
      clearMetrics();
      setStatus("se încarcă…", "warn");

      if (DEBUG && lastUrlChip) {
        lastUrlText.textContent = `URL: ${url}`;
        lastUrlChip.style.display = "";
      }

      const res = await fetch(url, { headers });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch (_) {}

      if (DEBUG && rawEl) rawEl.textContent = text;

      if (res.status === 401) {
        setStatus("neautorizat (token invalid/expirat).", "err");
        return null;
      }
      if (res.status === 403) {
        const err = (json && (json.error || json.message)) ? (json.error || json.message) : "interzis";
        setStatus(`acces interzis (${err}).`, "warn");
        return json || { ok:false, error: err };
      }
      if (!res.ok) {
        setStatus(`eroare HTTP ${res.status}.`, "err");
        return null;
      }

      setStatus("OK", "ok");
      return json ?? {};
    } catch (e) {
      console.error(e);
      setStatus("eroare de rețea (verifică conexiunea).", "err");
      return null;
    } finally {
      setLoading(false);
    }
  }

  // Handlers
  btnLatest.addEventListener("click", async () => {
    const siteId = getSiteId();
    const data = await apiGet(`/api/live/latest?site_id=${encodeURIComponent(siteId)}`);
    if (!data) return;
    applySnapshot(data);
  });

  btnSummary.addEventListener("click", async () => {
    const siteId = getSiteId();
    const data = await apiGet(`/api/live/summary?site_id=${encodeURIComponent(siteId)}`);
    if (!data) return;
    applySnapshot(data);
  });

  btnHistory.addEventListener("click", async () => {
    setLoading(true);
    clearMetrics();
    const siteId = getSiteId();
    const data = await apiGet(`/api/live/history?site_id=${encodeURIComponent(siteId)}`);
    setLoading(false);

    if (!data) return;

    if (data && data.error === "premium_required") {
      setStatus("Istoric: Premium necesar.", "warn");
    } else {
      setStatus("Istoric: disponibil în curând.", "warn");
    }
  });

  // Init
  setDebugVisible();
  clearMetrics();
  setStatus("aștept token (autentificare necesară).", "neutral");
  </script>
</body>
</html>
