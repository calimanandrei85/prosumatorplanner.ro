<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>ProsumatorPlanner – Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ProsumatorPlanner Live – valori în timp real (cu autentificare)." />

  <style>
    :root{
      --primary:#0f766e;
      --primary-dark:#115e59;
      --accent:#f97316;
      --bg:#0f172a;
      --card-bg:#020617;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;
      --border:#1f2937;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: var(--text-main);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a{ color: inherit; text-decoration: none; }
    a:hover{ text-decoration: underline; }

    /* Sticky header (similar to home) */
    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .header-inner{
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 16px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
    }

    .header-left{ display:flex; align-items:center; justify-content:flex-start; }
    .header-title{
      text-align:center;
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 1.05rem;
      white-space: nowrap;
    }
    .header-right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      color: rgba(229,231,235,0.75);
      font-size: 12px;
    }

    .btn{
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease, border-color 0.2s ease;
      background: rgba(2, 6, 23, 0.55);
      color: var(--text-main);
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(249,115,22,0.9);
      box-shadow: 0 10px 25px rgba(15,23,42,0.35);
      text-decoration: none;
    }

    .btn-primary{
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-color: rgba(31,41,55,0.9);
      color: #ecfeff;
    }
    .btn-primary:hover{
      box-shadow: 0 14px 30px rgba(8,47,35,0.6);
      border-color: rgba(34,197,94,0.6);
    }

    .icon{
      width: 22px;
      height: 22px;
      border-radius: 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(circle at 30% 0, #a7f3d0, #22c55e 40%, #0f766e 100%);
      color: #022c22;
      font-weight: 900;
      font-size: 14px;
    }

    main{
      width: 100%;
      max-width: 1100px;
      margin: 18px auto 0;
      padding: 0 16px 18px;
      flex: 1;
    }

    .panel{
      background: rgba(15,23,42,0.92);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.6);
    }

    .kicker{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #6ee7b7;
      margin-bottom: 10px;
    }

    h2{
      font-size: 22px;
      margin-bottom: 8px;
    }

    .subtitle{
      color: var(--text-muted);
      font-size: 14px;
      max-width: 800px;
    }

    .grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .card{
      background: rgba(2,6,23,0.6);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
    }

    .card h3{
      font-size: 14px;
      margin-bottom: 8px;
    }

    .form-group{ display:flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    label{ font-size: 13px; color: var(--text-main); font-weight: 600; }

    input, textarea{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.75);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
    }
    input:focus, textarea:focus{ border-color: rgba(34,197,94,0.6); }

    .actions{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .results{
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .metric{
      background: rgba(15,23,42,0.85);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }
    .metric .label{
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 4px;
    }
    .metric .value{
      font-size: 16px;
      font-weight: 800;
    }
    .metric .hint{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(229,231,235,0.8);
    }

    pre{
      margin-top: 10px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      overflow-x: auto;
      font-size: 12px;
      display:none; /* nu mai arătăm “comenzi GET” */
    }

    /* Footer identical to home */
    .site-footer{
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      font-size: 12px;
      background: #020617;
      color: var(--text-muted);
    }
    .footer-inner{
      max-width: 1100px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }
    .footer-left{ display:flex; flex-direction: column; gap: 2px; }
    .footer-app-name{ font-weight: 700; color: var(--text-main); }
    .footer-copy{ font-size: 11px; color: var(--text-muted); }
    .footer-links{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .footer-links a{ color: var(--text-muted); text-decoration:none; }
    .footer-links a:hover{ color: var(--text-main); text-decoration: underline; }
    .footer-divider{ opacity: 0.6; }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .results{ grid-template-columns: 1fr; }
      .header-right{ display:none; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="header-left">
        <a class="btn" href="index.html" aria-label="Înapoi la pagina principală">
          <span class="icon">P</span>
          Înapoi acasă
        </a>
      </div>

      <div class="header-title">ProsumatorPlanner – Live</div>

      <div class="header-right">
        <a class="btn" href="https://api.prosumatorplanner.ro/docs" target="_blank" rel="noopener">Swagger</a>
      </div>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="kicker">Live · Autentificat · Real-time</div>
      <h2>Live UI (doar cu autentificare)</h2>
      <p class="subtitle">
        Această pagină nu expune date publice. Pentru a vedea valori, introdu un token JWT valid.
        Token-ul este folosit doar în browser-ul tău pentru a apela API-ul.
      </p>

      <div class="grid">
        <div class="card">
          <h3>Autentificare</h3>

          <div class="form-group">
            <label for="siteId">Site ID</label>
            <input id="siteId" type="number" min="1" step="1" value="1" />
          </div>

          <div class="form-group">
            <label for="token">JWT Token (Bearer)</label>
            <textarea id="token" rows="4" placeholder="Lipește aici token-ul (fără 'Bearer ')"></textarea>
          </div>

          <div class="actions">
            <button class="btn btn-primary" id="btnLatest">Fetch latest</button>
            <button class="btn btn-primary" id="btnSummary">Fetch summary</button>
            <button class="btn" id="btnHistory">Fetch history (Premium)</button>
          </div>

          <div class="status" id="status">Status: aștept token.</div>
        </div>

        <div class="card">
          <h3>Rezultate</h3>

          <div class="results" id="results">
            <div class="metric">
              <div class="label">PV</div>
              <div class="value" id="pv">—</div>
              <div class="hint">kW (instant)</div>
            </div>
            <div class="metric">
              <div class="label">House</div>
              <div class="value" id="house">—</div>
              <div class="hint">kW (instant)</div>
            </div>
            <div class="metric">
              <div class="label">Grid</div>
              <div class="value" id="grid">—</div>
              <div class="hint">import/export kW</div>
            </div>
            <div class="metric">
              <div class="label">Battery</div>
              <div class="value" id="soc">—</div>
              <div class="hint">SOC %</div>
            </div>
            <div class="metric">
              <div class="label">Status</div>
              <div class="value" id="connected">—</div>
              <div class="hint">connected / last_update</div>
            </div>
            <div class="metric">
              <div class="label">Max PV today</div>
              <div class="value" id="maxpv">—</div>
              <div class="hint">kW (azi)</div>
            </div>
          </div>

          <pre id="raw"></pre>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-left">
        <span class="footer-app-name">ProsumatorPlanner</span>
        <span class="footer-copy">© <span id="year">2025</span> Andrei Căliman. Toate drepturile rezervate.</span>
      </div>

      <div class="footer-links">
        <a href="live.html">Live</a>
        <span class="footer-divider">•</span>
        <a href="privacy-policy.html">Privacy Policy</a>
        <span class="footer-divider">•</span>
        <a href="terms.html">Terms &amp; Conditions</a>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const API_BASE = "https://api.prosumatorplanner.ro";
    const statusEl = document.getElementById("status");
    const rawEl = document.getElementById("raw");

    const elPv = document.getElementById("pv");
    const elHouse = document.getElementById("house");
    const elGrid = document.getElementById("grid");
    const elSoc = document.getElementById("soc");
    const elConnected = document.getElementById("connected");
    const elMaxPv = document.getElementById("maxpv");

    function getAuthHeader() {
      const token = document.getElementById("token").value.trim();
      if (!token) return null;
      return { "Authorization": `Bearer ${token}` };
    }

    function getSiteId() {
      const v = Number(document.getElementById("siteId").value);
      return Number.isFinite(v) && v > 0 ? v : 1;
    }

    function setStatus(msg, isError=false) {
      statusEl.textContent = `Status: ${msg}`;
      statusEl.style.color = isError ? "#fca5a5" : "";
    }

    function fmtNum(v) {
      if (v === null || v === undefined || v === "") return "—";
      const n = Number(v);
      if (!Number.isFinite(n)) return String(v);
      return n.toFixed(3).replace(/\.?0+$/,""); // 2.350 -> 2.35
    }

    function updateFromLatest(data) {
      // așteptăm structura din backend: { ok, site_id, connected, last_update, latest, max_pv_kw_today }
      const latest = data.latest || {};
      elPv.textContent = fmtNum(latest.pv_kw);
      elHouse.textContent = fmtNum(latest.house_kw);

      // grid import/export afișăm compact
      const gi = fmtNum(latest.grid_import_kw);
      const ge = fmtNum(latest.grid_export_kw);
      elGrid.textContent = `${gi} / ${ge}`;

      elSoc.textContent = (latest.battery_soc === null || latest.battery_soc === undefined) ? "—" : `${latest.battery_soc}%`;

      const conn = data.connected ? "connected" : "not connected";
      const lu = data.last_update ? new Date(data.last_update).toISOString() : "—";
      elConnected.textContent = conn;
      elConnected.nextElementSibling && (elConnected.nextElementSibling.textContent = `connected / last_update: ${lu}`);

      elMaxPv.textContent = fmtNum(data.max_pv_kw_today);
    }

    async function apiGet(path) {
      const headers = getAuthHeader();
      if (!headers) {
        setStatus("token lipsă (nu permitem acces fără autentificare).", true);
        return null;
      }

      setStatus("se încarcă…");
      rawEl.style.display = "none";
      rawEl.textContent = "";

      const url = `${API_BASE}${path}`;
      const res = await fetch(url, { headers });
      const text = await res.text();

      let json = null;
      try { json = JSON.parse(text); } catch(_) {}

      if (!res.ok) {
        const msg = (json && (json.message || json.error)) ? (json.message || json.error) : `HTTP ${res.status}`;
        setStatus(msg, true);

        // pentru debug (doar dacă vrei): afișăm răspunsul brut
        rawEl.style.display = "block";
        rawEl.textContent = text;
        return null;
      }

      setStatus("OK");
      return json ?? text;
    }

    document.getElementById("btnLatest").addEventListener("click", async () => {
      const siteId = getSiteId();
      const data = await apiGet(`/api/live/latest?site_id=${encodeURIComponent(siteId)}`);
      if (!data) return;

      updateFromLatest(data);
      rawEl.style.display = "block";
      rawEl.textContent = JSON.stringify(data, null, 2);
    });

    document.getElementById("btnSummary").addEventListener("click", async () => {
      const siteId = getSiteId();
      const data = await apiGet(`/api/live/summary?site_id=${encodeURIComponent(siteId)}`);
      if (!data) return;

      // summary poate fi diferit ca structură; îl arătăm ca raw (și apoi rafinăm)
      rawEl.style.display = "block";
      rawEl.textContent = JSON.stringify(data, null, 2);
    });

    document.getElementById("btnHistory").addEventListener("click", async () => {
      const siteId = getSiteId();

      // interval default: ultimele 24h (UTC) + bucket 5
      const now = new Date();
      const to = now.toISOString();
      const from = new Date(now.getTime() - 24*60*60*1000).toISOString();
      const bucket = 5;

      const data = await apiGet(`/api/live/history?site_id=${encodeURIComponent(siteId)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&bucket_minutes=${bucket}`);
      if (!data) return;

      rawEl.style.display = "block";
      rawEl.textContent = JSON.stringify(data, null, 2);
    });
  </script>
</body>
</html>
